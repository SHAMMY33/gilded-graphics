<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop • Gilded Graphics</title>
  <meta name="description" content="Product list for apparel and design services." />
  <link rel="stylesheet" href="css/style.css?v=4" />
</head>

<body>
  <div class="bar">
    <span>DTF PRINT • DESIGN • FAST TURNAROUNDS</span>
    <span class="dot">•</span>
    <span>FREE LOCAL SHIPPING</span>
  </div>

  <header class="nav">
    <a class="brand" href="index.html">GILDED</a>
    <nav class="links">
      <a class="active" href="shop.html">Shop</a>
      <a href="work.html">Work</a>
      <a class="btn" href="order.html">Start an Order</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="pagehead">
      <h1>Products</h1>
      <p class="muted">Add items to cart. Checkout will open Stripe.</p>
    </section>

    <section class="shop-bar">
      <button class="filter-btn" type="button" disabled>Filter</button>

      <div style="display:flex; gap:10px; align-items:center;">
        <a class="smallbtn" href="order.html">Need a custom quote?</a>

        <button class="smallbtn" id="openCartBtn" type="button">
          Cart <span id="cartCount" class="badge">0</span>
        </button>
      </div>
    </section>

    <section class="products" id="productGrid"></section>

    <footer class="footer">
      <div class="footer-row">
        <a class="muted" href="index.html">Home</a>
        <a class="muted" href="order.html">Order</a>
        <a class="muted" href="mailto:gildedgraphicz@gmail.com">Email</a>
      </div>
    </footer>
  </main>

  <!-- Backdrop (click to close) -->
  <div class="cart-backdrop" id="cartBackdrop" hidden></div>

  <!-- Cart Drawer -->
  <aside class="cart" id="cartDrawer" hidden aria-hidden="true">
    <div class="cart-top">
      <h2>Your Cart</h2>
      <button class="smallbtn" id="closeCartBtn" type="button">Close</button>
    </div>

    <div class="cart-items" id="cartItems"></div>

    <div class="cart-actions">
      <button class="btn full" id="checkoutBtn" type="button">
        Checkout
      </button>
      <button class="smallbtn" id="clearCartBtn" type="button">
        Clear cart
      </button>
    </div>

    <p class="notice">
      Final pricing + confirmation will happen at checkout.
    </p>
  </aside>

  <script src="assets/cart.js?v=4"></script>

  <script>
    function toast(msg) {
      const t = document.createElement("div");
      t.textContent = msg;
      t.style.position = "fixed";
      t.style.right = "18px";
      t.style.bottom = "18px";
      t.style.padding = "10px 12px";
      t.style.border = "1px solid rgba(0,0,0,.15)";
      t.style.background = "#fff";
      t.style.fontWeight = "800";
      t.style.zIndex = "9999";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1400);
    }

    // Add products here (copy/paste an object)
    const PRODUCTS = [
      {
        sku: "red_sea_surf_classic",
        name: "Red Sea Surf Classic",
        desc: "DTF tee print • bold + clean • fast turnaround",
        image: "assets/images/red-sea-surf-classic.jpg",
        tag: "Best Seller"
      }
    ];

    // Render product grid
    const grid = document.getElementById("productGrid");
    grid.innerHTML = PRODUCTS.map(p => `
      <article class="p-card">
        <div class="p-img">
          ${p.image ? `<img src="${p.image}" alt="${p.name}" onerror="this.remove()">` : ``}
        </div>

        <div class="p-body">
          <div class="p-top" style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h3 style="margin:0;">${p.name}</h3>
            ${p.tag ? `<span class="tag" style="border:1px solid rgba(0,0,0,.12); padding:6px 10px; font-size:12px; font-weight:800;">${p.tag}</span>` : ``}
          </div>

          <p style="margin-top:8px;">${p.desc}</p>

          <div class="p-actions" style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="smallbtn" type="button" data-add="1" data-sku="${p.sku}">
              Add to cart
            </button>
            <a class="smallbtn" href="order.html">Get a quote</a>
          </div>
        </div>
      </article>
    `).join("");

    // Badge update
    function syncBadge() {
      const badge = document.getElementById("cartCount");
      if (!badge) return;

      if (window.Cart && typeof window.Cart.count === "function") {
        badge.textContent = String(window.Cart.count());
        return;
      }

      try {
        const raw = localStorage.getItem("gilded_cart_v1");
        const items = raw ? JSON.parse(raw) : [];
        const total = Array.isArray(items)
          ? items.reduce((s, i) => s + (Number(i.qty) || 0), 0)
          : 0;
        badge.textContent = String(total);
      } catch {
        badge.textContent = "0";
      }
    }

    // Wire add buttons
    function wireAddButtons() {
      document.querySelectorAll("[data-add][data-sku]").forEach(btn => {
        btn.addEventListener("click", () => {
          const sku = btn.getAttribute("data-sku");

          if (!window.Cart) {
            console.error("Cart not loaded. assets/cart.js missing?");
            toast("Cart script failed to load");
            return;
          }

          window.Cart.add(sku, 1);
          syncBadge();
          toast("Added to cart");
        });
      });
    }

    // Drawer + Backdrop
    const drawer = document.getElementById("cartDrawer");
    const backdrop = document.getElementById("cartBackdrop");
    const cartItemsEl = document.getElementById("cartItems");

    function openCart() {
      drawer.hidden = false;
      backdrop.hidden = false;
      drawer.setAttribute("aria-hidden", "false");

      // allow CSS to animate in
      requestAnimationFrame(() => drawer.classList.add("is-open"));

      renderCart();
    }

    function closeCart() {
      drawer.classList.remove("is-open");
      drawer.setAttribute("aria-hidden", "true");

      // wait for slide-out transition, then hide
      setTimeout(() => {
        drawer.hidden = true;
        backdrop.hidden = true;
      }, 180);
    }

    function renderCart() {
      if (!window.Cart) return;

      const items = window.Cart.read();
      cartItemsEl.innerHTML = "";

      if (!items.length) {
        cartItemsEl.innerHTML = "<p class='muted'>Your cart is empty.</p>";
        return;
      }

      items.forEach(item => {
        const product = PRODUCTS.find(p => p.sku === item.sku);

        const row = document.createElement("div");
        row.className = "cart-item";

        row.innerHTML = `
          <div class="cart-left">
            <span class="cart-title">${product ? product.name : item.sku}</span>
            <span class="cart-price">Quantity</span>
          </div>

          <div class="cart-right">
            <input class="qty" type="number" min="1" value="${Number(item.qty) || 1}" />
            <button class="smallbtn" type="button" aria-label="Remove">✕</button>
          </div>
        `;

        row.querySelector("input").addEventListener("change", e => {
          const nextQty = Math.max(1, Number(e.target.value || 1));
          window.Cart.setQty(item.sku, nextQty);
          syncBadge();
          renderCart();
        });

        row.querySelector("button").addEventListener("click", () => {
          window.Cart.remove(item.sku);
          syncBadge();
          renderCart();
        });

        cartItemsEl.appendChild(row);
      });
    }

    // Open / close cart
    document.getElementById("openCartBtn").addEventListener("click", openCart);
    document.getElementById("closeCartBtn").addEventListener("click", closeCart);

    // Click backdrop to close
    backdrop.addEventListener("click", closeCart);

    // ESC to close
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !drawer.hidden) closeCart();
    });

    // Clear cart
    document.getElementById("clearCartBtn").addEventListener("click", () => {
      window.Cart.clear();
      syncBadge();
      renderCart();
    });

    // Checkout (placeholder for next step)
    document.getElementById("checkoutBtn").addEventListener("click", () => {
      toast("Next: connect checkout to Stripe");
    });

    // Init
    syncBadge();
    wireAddButtons();
    console.log("Shop scripts loaded. Cart present:", !!window.Cart);
  </script>
</body>
</html>
