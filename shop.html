<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shop • Gilded Graphics</title>
  <meta name="description" content="Product list for apparel and design services." />
  <link rel="stylesheet" href="css/style.css?v=4" />
</head>

<body>
  <div class="bar">
    <span>DTF PRINT • DESIGN • FAST TURNAROUNDS</span>
    <span class="dot">•</span>
    <span>FREE LOCAL SHIPPING</span>
  </div>

  <header class="nav">
    <a class="brand" href="index.html">GILDED</a>

    <nav class="links">
      <a class="active" href="shop.html">Shop</a>
      <a href="work.html">Work</a>

      <!-- Cart icon (between Work and Start an Order) -->
      <button class="iconbtn" id="openCartBtn" type="button" aria-label="Open cart">
        <img
          id="cartIcon"
          src="assets/images/shopping-bag-empty.png"
          alt="Cart"
        />
        <span id="cartCount" class="badge" aria-label="Cart item count">0</span>
      </button>

      <a class="btn" href="order.html">Start an Order</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="pagehead">
      <h1>Products</h1>
      <p class="muted">Add items to cart. Checkout will open Stripe.</p>
    </section>

    <!-- Products render here -->
    <section class="products" id="productGrid"></section>

    <!-- Backdrop -->
    <div class="cart-backdrop" id="cartBackdrop" hidden></div>

    <!-- Cart Drawer -->
    <aside class="cart" id="cartDrawer" hidden aria-label="Cart drawer">
      <div class="cart-top">
        <h2>Your Cart</h2>
        <button class="smallbtn" id="closeCartBtn" type="button">Close</button>
      </div>

      <div class="cart-items" id="cartItems"></div>

      <div class="cart-actions">
        <button class="btn full" id="checkoutBtn" type="button">Checkout</button>
        <button class="smallbtn" id="clearCartBtn" type="button">Clear cart</button>
      </div>

      <p class="notice">
        Checkout opens Stripe. Cart items are sent as a bundle.
      </p>
    </aside>

    <footer class="footer">
      <div class="footer-row">
        <a class="muted" href="index.html">Home</a>
        <a class="muted" href="order.html">Order</a>
        <a class="muted" href="mailto:gildedgraphicz@gmail.com">Email</a>
      </div>
    </footer>
  </main>

  <!-- cart storage -->
  <script src="assets/cart.js?v=4"></script>

  <script>
    // ---------- tiny toast ----------
    function toast(msg) {
      const t = document.createElement("div");
      t.textContent = msg;
      t.style.position = "fixed";
      t.style.right = "18px";
      t.style.bottom = "18px";
      t.style.padding = "10px 12px";
      t.style.border = "1px solid rgba(0,0,0,.15)";
      t.style.background = "#fff";
      t.style.fontWeight = "800";
      t.style.zIndex = "9999";
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1400);
    }

    // ---------- products (add more by copying an object) ----------
    const PRODUCTS = [
      {
        sku: "red_sea_surf_classic",
        name: "Red Sea Surf Classic",
        price: 35,
        desc: "DTF tee print • bold + clean",
        image: "assets/images/products/red_sea001.jpg",
        tag: "Best Seller"
      },
      {
        sku: "dtf_hoodie_print",
        name: "DTF Hoodie Print",
        price: 50,
        desc: "Front/back options • heavyweight • durable prints",
        image: "assets/images/products/dtf_hoodie001.jpg",
        tag: ""
      }
    ];

    // ---------- helpers ----------
    function byId(id){ return document.getElementById(id); }

    function updateCartIconAndBadge() {
      const badge = byId("cartCount");
      const icon = byId("cartIcon");
      if (!badge || !icon || !window.Cart) return;

      const n = window.Cart.count();
      badge.textContent = String(n);

      icon.src = n > 0
        ? "assets/images/shopping-bag-full.png"
        : "assets/images/shopping-bag-empty.png";
    }

    function renderProducts() {
      const grid = byId("productGrid");
      if (!grid) return;

      grid.innerHTML = PRODUCTS.map(p => `
        <article class="p-card">
          <div class="p-img">
            ${p.image ? `<img src="${p.image}" alt="${p.name}" onerror="this.remove()">` : ``}

            <!-- Add-to-cart bag (BOTTOM-LEFT per your request) -->
            <button class="add-bag" type="button" data-sku="${p.sku}" aria-label="Add ${p.name} to cart">
              <img src="assets/images/shopping-bag-empty.png" alt="" aria-hidden="true">
            </button>
          </div>

          <div class="p-body">
            <div class="p-top">
              <h3>${p.name}</h3>
              ${p.tag ? `<span class="tag">${p.tag}</span>` : ``}
            </div>

            <div class="price">$${Number(p.price).toFixed(2)}</div>

            <p>${p.desc}</p>
          </div>
        </article>
      `).join("");

      // wire bag buttons
      grid.querySelectorAll("button.add-bag[data-sku]").forEach(btn => {
        btn.addEventListener("click", () => {
          if (!window.Cart) {
            console.error("Cart not loaded (assets/cart.js).");
            toast("Cart failed to load");
            return;
          }

          const sku = btn.getAttribute("data-sku");
          window.Cart.add(sku, 1);

          updateCartIconAndBadge();
          toast("Added to cart");

          // tell other listeners (optional)
          window.dispatchEvent(new Event("gilded:cart-changed"));
        });
      });
    }

    function renderCart() {
      const itemsEl = byId("cartItems");
      if (!itemsEl || !window.Cart) return;

      const items = window.Cart.read();
      itemsEl.innerHTML = "";

      if (!items.length) {
        itemsEl.innerHTML = "<p class='muted'>Your cart is empty.</p>";
        return;
      }

      items.forEach(item => {
        const product = PRODUCTS.find(p => p.sku === item.sku);

        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <div class="cart-left">
            <span class="cart-title">${product ? product.name : item.sku}</span>
            <span class="cart-price">$${product ? Number(product.price).toFixed(2) : "—"} • Qty</span>
          </div>

          <div class="cart-right">
            <input class="qty" type="number" min="1" value="${Number(item.qty) || 1}" />
            <button class="smallbtn" type="button" aria-label="Remove">✕</button>
          </div>
        `;

        const qtyInput = row.querySelector("input.qty");
        const removeBtn = row.querySelector("button[aria-label='Remove']");

        qtyInput.addEventListener("change", () => {
          const next = parseInt(qtyInput.value, 10);
          window.Cart.setQty(item.sku, Number.isFinite(next) ? next : (Number(item.qty) || 1));
          updateCartIconAndBadge();
          renderCart();
          window.dispatchEvent(new Event("gilded:cart-changed"));
        });

        removeBtn.addEventListener("click", () => {
          window.Cart.remove(item.sku);
          updateCartIconAndBadge();
          renderCart();
          window.dispatchEvent(new Event("gilded:cart-changed"));
        });

        itemsEl.appendChild(row);
      });
    }

    // ---------- drawer controls ----------
    const drawer = byId("cartDrawer");
    const backdrop = byId("cartBackdrop");

    function openCart(){
      if (!drawer || !backdrop) return;
      drawer.hidden = false;
      backdrop.hidden = false;
      drawer.classList.add("is-open");
      updateCartIconAndBadge();
      renderCart();
    }

    function closeCart(){
      if (!drawer || !backdrop) return;
      drawer.classList.remove("is-open");
      setTimeout(() => {
        drawer.hidden = true;
        backdrop.hidden = true;
      }, 180);
    }

    // ---------- init ----------
    console.log("Shop scripts loaded. Cart present:", !!window.Cart);

    renderProducts();
    updateCartIconAndBadge();

    byId("openCartBtn")?.addEventListener("click", openCart);
    byId("closeCartBtn")?.addEventListener("click", closeCart);
    backdrop?.addEventListener("click", closeCart);

    byId("clearCartBtn")?.addEventListener("click", () => {
      window.Cart?.clear();
      updateCartIconAndBadge();
      renderCart();
      window.dispatchEvent(new Event("gilded:cart-changed"));
    });

    // Checkout stub (next step we connect to Stripe)
    byId("checkoutBtn")?.addEventListener("click", async () => {
      if (!window.Cart) return;
      const items = window.Cart.read();

      if (!items.length) {
        toast("Cart is empty");
        return;
      }

      toast("Next: send cart to Stripe checkout");
      console.log("Cart to checkout:", items);
    });

    // If any other page triggers updates (optional)
    window.addEventListener("gilded:cart-changed", () => {
      updateCartIconAndBadge();
      if (drawer && !drawer.hidden) renderCart();
    });
  </script>
</body>
</html>
